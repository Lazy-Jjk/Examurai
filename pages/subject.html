<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Papers - Examurai</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fb 0%, #a5b4fc 100%);
            font-family: 'Poppins', 'Inter', Arial, sans-serif;
        }
        .subject-header {
            margin: 120px auto 2rem auto;
            max-width: 900px;
            text-align: center;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(66, 99, 235, 0.10), 0 1.5px 6px rgba(0,0,0,0.04);
            padding: 2rem 2.5rem;
        }
        .subject-header .subject-name {
            font-size: 2.2rem;
            font-weight: 700;
            color: #3b5bdb;
        }
        .subject-header .subject-count {
            color: #7b88a8;
            font-size: 1.15rem;
            margin-top: 0.5rem;
        }
        .divider {
            width: 100%;
            max-width: 900px;
            margin: 0 auto 2rem auto;
            border-bottom: 1.5px solid #a5b4fc;
        }
        .interact-bar {
            max-width:900px;
            margin:0 auto 1.5rem auto;
            display:flex;
            gap:1rem;
            align-items:center;
            background: #e9edfb;
            border-radius: 14px;
            box-shadow: 0 1.5px 6px rgba(66,99,235,0.08);
            padding: 1rem 1.5rem;
        }
        .interact-bar input, .interact-bar select {
            border-radius: 8px;
            border: 1px solid #a5b4fc;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            background: #fff;
            transition: box-shadow 0.2s;
        }
        .interact-bar input:focus, .interact-bar select:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4263eb;
        }
        .papers-container {
            max-width: 900px;
            margin: 0 auto 2rem auto;
            padding: 1rem;
        }
        .papers-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        .paper-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(66,99,235,0.09), 0 1.5px 6px rgba(0,0,0,0.04);
            padding: 1.5rem 1.2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid #a5b4fc;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .paper-card:hover {
            box-shadow: 0 6px 24px rgba(66,99,235,0.18), 0 2px 8px rgba(0,0,0,0.06);
            transform: translateY(-2px) scale(1.012);
        }
        .paper-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: #3b5bdb;
            cursor: pointer;
        }
        .paper-meta {
            color: #7b88a8;
            font-size: 1rem;
        }
        .paper-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 1rem;
        }
        .download-btn, .bookmark-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .download-btn {
            background: linear-gradient(90deg, #3b5bdb 0%, #4263eb 100%);
            color: white;
            box-shadow: 0 1.5px 6px rgba(66,99,235,0.13);
        }
        .download-btn:hover {
            background: linear-gradient(90deg, #1c3486 0%, #3b5bdb 100%);
        }
        .bookmark-btn {
            background: #f5f7fb;
            color: #3b5bdb;
            border: 1px solid #a5b4fc;
        }
        .bookmark-btn.bookmarked {
            background: #4263eb;
            color: white;
        }
        .bookmark-btn:hover {
            background: #a5b4fc;
            color: #3b5bdb;
        }
        #pagination button {
            background: #e9edfb;
            color: #3b5bdb;
            border: 1px solid #a5b4fc;
            border-radius: 8px;
            padding: 0.4rem 1.2rem;
            margin: 0 0.2rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        #pagination button:disabled {
            background: #f5f7fb;
            color: #a5b4fc;
            cursor: not-allowed;
        }
        #toast {
            font-family: 'Poppins', 'Inter', Arial, sans-serif;
        }
        @media (max-width: 600px) {
            .subject-header, .interact-bar, .papers-container { padding: 1rem; }
            .subject-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .interact-bar { flex-direction: column; gap: 0.7rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo" onclick="window.location.href='../index.html'" style="cursor: pointer;">Examurai</div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <a href="account.html">Account</a>
                <a href="upload.html">Contributions</a>
                <a href="bookmarks.html">Bookmarks</a>
                <a href="filters.html">Filter</a>
                <a href="contact.html">Contact Us</a>
            </div>
        </div>
    </nav>
    <main>
        <div class="subject-header" id="subjectHeader">
            <!-- Subject info will be loaded here -->
        </div>
        <div class="divider"></div>
        <div class="interact-bar" style="max-width:900px;margin:0 auto 1rem auto;display:flex;gap:1rem;align-items:center;">
            <select id="collegeFilter" style="flex:1;padding:0.5rem 1rem;border-radius:8px;border:1px solid #a5b4fc;">
                <option value="">All Colleges</option>
                <option value="JNTUH">JNTUH</option>
                <option value="JNTUA">JNTUA</option>
                <option value="JNTUK">JNTUK</option>
                <option value="OU">OU</option>
                <option value="MVSR">MVSR</option>
                <option value="Vasavi">Vasavi</option>
                <option value="CBIT">CBIT</option>
                <option value="GNIT">GNIT</option>
            </select>
            <select id="branchFilter" style="flex:1;padding:0.5rem 1rem;border-radius:8px;border:1px solid #a5b4fc;">
                <option value="">All Branches</option>
                <option value="Computer Science Engineering">Computer Science Engineering</option>
                <option value="Electronics & Communication Engineering">Electronics & Communication Engineering</option>
                <option value="Electrical & Electronics Engineering">Electrical & Electronics Engineering</option>
                <option value="Mechanical Engineering">Mechanical Engineering</option>
                <option value="Chemical Engineering">Chemical Engineering</option>
                <option value="Biotechnology Engineering">Biotechnology Engineering</option>
                <option value="Civil Engineering">Civil Engineering</option>
                <option value="Metallurgical Engineering">Metallurgical Engineering</option>
            </select>
            <select id="semesterFilter" style="flex:1;padding:0.5rem 1rem;border-radius:8px;border:1px solid #a5b4fc;">
                <option value="">All Semesters</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </div>
        <div class="papers-container">
            <div class="papers-list" id="papersList">
                <!-- Papers will be loaded here -->
            </div>
            <div id="pagination" style="text-align:center;margin-top:1rem;"></div>
        </div>
        <div id="toast" style="position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:12px 24px;border-radius:8px;display:none;z-index:9999;font-size:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.15);"></div>
    </main>
    <script>
    // Helper to get query param
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    const subject = getQueryParam('subject');
    if (!subject) {
        document.getElementById('subjectHeader').innerHTML = '<h2>No subject specified.</h2>';
        document.getElementById('papersList').innerHTML = '';
    } else {
        document.getElementById('subjectHeader').innerHTML = `<div class='subject-name' style='font-size:2.2rem;font-weight:700;color:#3b5bdb;'>${subject}</div>`;
        loadSubjectHeader(subject);
        loadSubjectPapers(subject);
    }

    async function loadSubjectHeader(subject) {
        // Get paper count for this subject
        try {
            const res = await fetch(`/api/subjects/${encodeURIComponent(subject)}/papers`);
            const papers = await res.json();
            document.getElementById('subjectHeader').innerHTML = `
                <div class="subject-name">${subject}</div>
                <div class="subject-count">${papers.length} papers available</div>
            `;
        } catch (err) {
            document.getElementById('subjectHeader').innerHTML = `<h2>${subject}</h2>`;
        }
    }

    let allPapers = [];
    let filteredPapers = [];
    let currentPage = 1;
    const pageSize = 8;
    let userBookmarks = [];

    async function loadSubjectPapers(subject) {
        try {
            const res = await fetch(`/api/subjects/${encodeURIComponent(subject)}/papers`);
            const papers = await res.json();
            renderPapers(papers);
        } catch (err) {
            document.getElementById('papersList').innerHTML = '<div style="color:#7c3aed;text-align:center;padding:2rem 0;">Failed to load papers.</div>';
        }
    }

    function populateFilters(papers) {
        const years = Array.from(new Set(papers.map(p=>p.year))).sort();
        const semesters = Array.from(new Set(papers.map(p=>p.semester))).sort();
        const yearFilter = document.getElementById('yearFilter');
        const semesterFilter = document.getElementById('semesterFilter');
        yearFilter.innerHTML = '<option value="">All Years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
        semesterFilter.innerHTML = '<option value="">All Semesters</option>' + semesters.map(s=>`<option value="${s}">${s}</option>`).join('');
    }

    function applyFiltersAndRender() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const year = document.getElementById('yearFilter').value;
        const semester = document.getElementById('semesterFilter').value;
        const sort = document.getElementById('sortSelect').value;
        filteredPapers = allPapers.filter(paper => {
            return (!search || paper.course.toLowerCase().includes(search) || paper.college.toLowerCase().includes(search)) &&
                   (!year || paper.year == year) &&
                   (!semester || paper.semester == semester);
        });
        // Sort
        if (sort === 'newest') filteredPapers.sort((a,b)=>new Date(b.uploaded_at)-new Date(a.uploaded_at));
        else if (sort === 'oldest') filteredPapers.sort((a,b)=>new Date(a.uploaded_at)-new Date(b.uploaded_at));
        else if (sort === 'yearAsc') filteredPapers.sort((a,b)=>a.year-b.year);
        else if (sort === 'yearDesc') filteredPapers.sort((a,b)=>b.year-a.year);
        currentPage = 1;
        renderPapers();
    }

    function renderPapers(papers) {
        console.log('Rendering papers:', papers); // DEBUG LOG
        if (papers.length > 0) {
            console.log('First paper object:', papers[0]); // DEBUG LOG
        }
        const papersList = document.getElementById('papersList');
        if (!papers.length) {
            papersList.innerHTML = '<div style="color:#7c3aed;text-align:center;padding:2rem 0;">No papers uploaded yet.</div>';
            return;
        }
        papersList.innerHTML = papers.map(paper => {
            const displayName = paper.name || paper.original_name || paper.filename || 'Untitled Paper';
            return `
            <div class="paper-card">
                <div class="paper-title">${displayName}</div>
                <div class="paper-meta"><strong>College:</strong> ${paper.college || '-'} &nbsp; <strong>Branch:</strong> ${paper.course || paper.branch || '-'} &nbsp; <strong>Semester:</strong> ${paper.semester || '-'}</div>
                <div class="paper-actions">
                    <a href="/api/download/${paper.id || paper.paper_id}" class="download-btn" target="_blank"><i class="fas fa-download"></i> Download</a>
                    <button class="bookmark-btn" data-paper-id="${paper.id || paper.paper_id}"><i class="fas fa-bookmark"></i> Bookmark</button>
                </div>
            </div>
            `;
        }).join('');
        papersList.querySelectorAll('.bookmark-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const paperId = btn.getAttribute('data-paper-id');
                try {
                    const res = await fetch('/api/bookmarks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paperId })
                    });
                    if (res.ok) {
                        btn.classList.toggle('bookmarked');
                    } else {
                        alert('Failed to bookmark.');
                    }
                } catch (e) {
                    alert('Failed to bookmark.');
                }
            });
        });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredPapers.length / pageSize);
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        renderPapers();
    }

    document.getElementById('searchInput').addEventListener('input', applyFiltersAndRender);
    document.getElementById('yearFilter').addEventListener('change', applyFiltersAndRender);
    document.getElementById('semesterFilter').addEventListener('change', applyFiltersAndRender);
    document.getElementById('sortSelect').addEventListener('change', applyFiltersAndRender);

    function toggleDetails(titleElem) {
        const details = titleElem.parentElement.querySelector('.details');
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.style.display = 'block';
        setTimeout(()=>{toast.style.display='none';}, 2000);
    }

    function downloadPaper(paperId, btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
        showToast('Download started');
        setTimeout(()=>{
            window.location.href = `/api/download/${paperId}`;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-download"></i> Download';
        }, 500);
    }

    async function bookmarkPaper(paperId, btn) {
        btn.disabled = true;
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        try {
            const res = await fetch('/api/bookmarks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paperId })
            });
            if (res.ok) {
                btn.classList.add('bookmarked');
                btn.innerHTML = '<i class="fas fa-bookmark"></i> Bookmarked';
                showToast('Bookmarked!');
            } else {
                btn.innerHTML = orig;
                showToast('Please sign in to bookmark papers.');
            }
        } catch {
            btn.innerHTML = orig;
            showToast('Error bookmarking paper.');
        }
        btn.disabled = false;
    }
    </script>
</body>
</html> 